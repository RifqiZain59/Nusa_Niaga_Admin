{% extends 'base.html' %}

{% block content %}

<style>
    /* --- PRINT CONFIGURATION --- */
    @media print {
        /* Sembunyikan elemen navigasi, tombol, dan dekorasi saat mencetak */
        #sidebar-wrapper, .navbar, .btn, .no-print, .alert, .modal, .sidebar-footer, footer, .badge-point-action {
            display: none !important;
        }
        
        /* Reset margin dan padding untuk kertas */
        #page-content-wrapper {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 20px !important;
        }

        /* Sembunyikan kolom "Aksi" pada tabel saat cetak */
        #customerTable th:last-child, #customerTable td:last-child {
            display: none !important;
        }

        /* Header Laporan khusus Print */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        body { 
            font-size: 12px; 
            background-color: white !important; 
            font-family: 'Times New Roman', Times, serif;
        }
        
        .table { 
            width: 100% !important; 
            border-collapse: collapse !important;
        }
        
        .table th, .table td {
            border: 1px solid #000 !important;
            padding: 5px !important;
        }
    }

    /* Sembunyikan Header Laporan di layar komputer */
    .print-header { display: none; }
</style>

<div class="print-header">
    <h2 class="mb-1 text-uppercase">Laporan Loyalitas Pelanggan</h2>
    <h4 class="mb-2">NUSA NIAGA - POS & CRM SYSTEM</h4>
    <p class="mb-0">Daftar Poin Member & Histori Penukaran Hadiah</p>
    <small>Dicetak pada: <span id="print_date_display"></span></small>
</div>

<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <h4 class="fw-bold text-primary mb-1">Loyalty Pelanggan</h4>
        <p class="text-muted small mb-0">Kelola poin member dan pemantauan reward.</p>
    </div>
    
    <div class="d-flex gap-2">
        <button onclick="shareToWhatsApp()" class="btn btn-success shadow-sm">
            <i class="fab fa-whatsapp me-2"></i> Kirim Laporan WA
        </button>
        <button onclick="printLaporan()" class="btn btn-danger shadow-sm">
            <i class="fas fa-file-pdf me-2"></i> Cetak Laporan PDF
        </button>
    </div>
</div>

<div class="alert alert-info py-2 px-3 mb-4 small border-0 bg-info bg-opacity-10 text-primary fw-bold shadow-sm no-print">
    <i class="fas fa-info-circle me-1"></i> Kurs Penukaran: 1 Poin = Rp 5.000
</div>

<div class="card p-4 border-0 shadow-sm mb-4">
    <h5 class="fw-bold mb-3"><i class="fas fa-users me-2 text-primary"></i>Daftar Poin Member</h5>
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="customerTable">
            <thead class="bg-light">
                <tr>
                    <th>Nama Pelanggan</th>
                    <th>No. HP</th>
                    <th class="text-center">Sisa Poin</th>
                    <th class="text-end">Nilai Rupiah</th>
                    <th class="text-center no-print">Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for c in customers %}
                <tr class="customer-row">
                    <td>
                        <a href="{{ url_for('customer_detail', id=c.id) }}" class="fw-bold text-decoration-none text-dark name-cell">
                            {{ c.name }}
                        </a>
                        <br><small class="text-muted d-print-none">{{ c.email }}</small>
                    </td>
                    <td class="phone-cell">{{ c.phone }}</td>
                    <td class="text-center">
                        <span class="badge bg-warning text-dark fs-6 px-3 rounded-pill border border-warning shadow-sm point-cell" data-points="{{ c.points }}">
                            {{ c.points }}
                        </span>
                    </td>
                    <td class="text-end fw-bold text-success">
                        Rp {{ "{:,.0f}".format(c.points * 5000) }}
                    </td>
                    <td class="text-center no-print">
                        <button type="button" class="btn btn-sm btn-primary shadow-sm px-3 badge-point-action" 
                                onclick="openCatalogModal(this)" 
                                data-id="{{ c.id }}" 
                                data-name="{{ c.name }}" 
                                data-points="{{ c.points }}">
                            <i class="fas fa-gift me-1"></i> Pilih Hadiah
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center py-5 text-muted">Belum ada pelanggan terdaftar.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card p-4 border-0 shadow-sm">
    <h5 class="fw-bold text-dark mb-3"><i class="fas fa-history me-2 text-warning"></i>Riwayat Penukaran Poin</h5>
    <div class="table-responsive">
        <table class="table table-hover align-middle table-bordered small" id="historyTable">
            <thead class="table-light">
                <tr>
                    <th>Tanggal & Waktu</th>
                    <th>Nama Pelanggan</th>
                    <th>Poin Keluar</th>
                    <th>Ditukar Untuk</th>
                </tr>
            </thead>
            <tbody>
                {% for log in history %}
                <tr class="history-row">
                    <td class="hist-date text-muted">{{ log.date.strftime('%d %b %Y, %H:%M') }}</td>
                    <td class="fw-bold hist-name">{{ log.customer.name }}</td>
                    <td class="text-danger fw-bold hist-points text-center">-{{ log.points_spent }}</td>
                    <td class="text-primary hist-desc">{{ log.description }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center py-3 text-muted">Belum ada riwayat penukaran poin.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="redeemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"> 
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-gift me-2"></i>Katalog Hadiah</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form action="{{ url_for('redeem_points') }}" method="POST" id="redeemForm">
                <div class="modal-body p-4">
                    <div class="alert alert-light border d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <small class="text-muted text-uppercase fw-bold">Pelanggan</small>
                            <h5 class="mb-0 fw-bold text-primary" id="modal_customer_name">Nama</h5>
                            <input type="hidden" name="customer_id" id="modal_customer_id">
                        </div>
                        <div class="text-end">
                            <small class="text-muted text-uppercase fw-bold">Poin Tersedia</small>
                            <h4 class="mb-0 fw-bold text-warning" id="modal_current_points">0</h4>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6 class="fw-bold mb-3 text-muted">Pilih Hadiah:</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="selected_item" id="item1" onclick="selectItem(10, 'Mug Cantik')">
                                    <label class="btn btn-outline-light text-dark border w-100 p-3 text-start h-100 position-relative" for="item1">
                                        Mug Cantik<br><b class="text-primary">10 Poin</b>
                                    </label>
                                </div>
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="selected_item" id="item2" onclick="selectItem(20, 'Payung Lipat')">
                                    <label class="btn btn-outline-light text-dark border w-100 p-3 text-start h-100 position-relative" for="item2">
                                        Payung Lipat<br><b class="text-primary">20 Poin</b>
                                    </label>
                                </div>
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="selected_item" id="item3" onclick="selectItem(30, 'Kaos Exclusive')">
                                    <label class="btn btn-outline-light text-dark border w-100 p-3 text-start h-100 position-relative" for="item3">
                                        Kaos Exclusive<br><b class="text-primary">30 Poin</b>
                                    </label>
                                </div>
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="selected_item" id="item4" onclick="selectItem(50, 'Voucher 250rb')">
                                    <label class="btn btn-outline-light text-dark border w-100 p-3 text-start h-100 position-relative" for="item4">
                                        Voucher Belanja<br><b class="text-primary">50 Poin</b>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5 text-center d-flex flex-column justify-content-center">
                            <input type="hidden" name="points_to_redeem" id="final_points">
                            <input type="hidden" name="description" id="final_desc">
                            
                            <div id="qr_placeholder" class="py-5 text-muted fst-italic">
                                <i class="fas fa-hand-pointer mb-3 d-block fa-3x text-light bg-secondary rounded-circle p-3 mx-auto" style="width: 80px; height: 80px;"></i>
                                <span class="d-block mt-2">Silakan pilih hadiah di samping untuk melanjutkan.</span>
                            </div>

                            <div id="qr_result" style="display: none;">
                                <div class="small mb-2 fw-bold text-uppercase text-muted">Scan QR Code</div>
                                
                                <img id="qr_image" src="" width="160" height="160" class="mb-3 border p-2 bg-white rounded shadow-sm" alt="QR Code">
                                
                                <div class="card bg-light border-0 p-3 mb-3 text-start shadow-sm">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small text-muted">Item:</span>
                                        <b id="summary_item" class="text-dark text-end"></b>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="small text-muted">Total Poin:</span>
                                        <b id="summary_points" class="text-danger text-end"></b>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning py-2 small border-0 text-center mb-0">
                                    <i class="fas fa-sync-alt me-1"></i> QR berubah tiap 20 menit.
                                </div>
                                
                                </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- 1. LOGIKA CETAK LAPORAN (PDF) ---
    function printLaporan() {
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('print_date_display').innerText = today.toLocaleString('id-ID', options) + " WIB";
        window.print();
    }

    // --- 2. LOGIKA KIRIM LAPORAN VIA WHATSAPP ---
    function shareToWhatsApp() {
        let custRows = document.querySelectorAll('.customer-row');
        let totalPoints = 0;
        let memberCount = 0;

        custRows.forEach(row => {
            if(row.style.display !== 'none') {
                totalPoints += parseInt(row.querySelector('.point-cell').getAttribute('data-points')) || 0;
                memberCount++;
            }
        });

        let histRows = document.querySelectorAll('.history-row');
        let histSummary = "";
        
        for(let i = 0; i < Math.min(histRows.length, 3); i++) {
            let row = histRows[i];
            if (row.querySelector('.hist-name')) { 
                let name = row.querySelector('.hist-name').innerText;
                let item = row.querySelector('.hist-desc').innerText;
                let pts = row.querySelector('.hist-points').innerText;
                histSummary += `â€¢ ${name}: ${item} (${pts})\n`;
            }
        }

        let message = `*LAPORAN LOYALTY NUSA NIAGA*\n\n`;
        message += `ðŸ“… Tanggal: ${new Date().toLocaleDateString('id-ID')}\n`;
        message += `ðŸ‘¥ Total Member: *${memberCount}*\n`;
        message += `ðŸ’Ž Total Poin Aktif: *${totalPoints} Poin*\n`;
        message += `ðŸ’° Valuasi Poin: *Rp ${new Intl.NumberFormat('id-ID').format(totalPoints * 5000)}*\n\n`;
        
        if(histSummary) {
            message += `*ðŸ”„ Riwayat Penukaran Terakhir:*\n${histSummary}`;
        } else {
            message += `*ðŸ”„ Riwayat Penukaran Terakhir:*\nBelum ada data.\n`;
        }
        
        message += `\n_Dikirim otomatis dari Sistem POS Nusa Niaga_`;
        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // --- 3. LOGIKA REDEEM & DYNAMIC QR ---
    let currentCustomerPoints = 0;
    let qrIntervalId = null; // Menyimpan ID interval untuk auto-refresh
    let currentSelectedItem = { pts: 0, name: '' }; // Menyimpan pilihan item saat ini

    function openCatalogModal(btn) {
        let custId = btn.dataset.id;
        let custName = btn.dataset.name;
        let custPoints = parseInt(btn.dataset.points);

        document.getElementById('modal_customer_id').value = custId;
        document.getElementById('modal_customer_name').innerText = custName;
        document.getElementById('modal_current_points').innerText = custPoints;
        
        currentCustomerPoints = custPoints;
        
        // Reset Tampilan ke awal (Placeholder)
        document.getElementById('qr_placeholder').style.display = 'block';
        document.getElementById('qr_result').style.display = 'none';
        
        // Bersihkan interval yang mungkin masih berjalan dari sesi sebelumnya
        if (qrIntervalId) clearInterval(qrIntervalId);

        // Reset radio button
        let radios = document.getElementsByName('selected_item');
        radios.forEach(r => r.checked = false);

        // Tampilkan Modal
        new bootstrap.Modal(document.getElementById('redeemModal')).show();
    }

    // Saat modal ditutup total, matikan interval agar tidak memakan memori browser
    document.getElementById('redeemModal').addEventListener('hidden.bs.modal', function () {
        if (qrIntervalId) clearInterval(qrIntervalId);
    });

    function selectItem(pts, name) {
        // Validasi Kecukupan Poin
        if(pts > currentCustomerPoints) { 
            alert(`Maaf, poin pelanggan tidak cukup!\nButuh: ${pts}, Punya: ${currentCustomerPoints}`);
            setTimeout(() => {
                event.target.checked = false; 
                document.getElementById('qr_placeholder').style.display = 'block';
                document.getElementById('qr_result').style.display = 'none';
            }, 100);
            return; 
        }

        // Simpan data item yang dipilih
        currentSelectedItem = { pts: pts, name: name };

        // Update Form Hidden Input & UI Teks
        document.getElementById('final_points').value = pts;
        document.getElementById('final_desc').value = name;
        document.getElementById('summary_item').innerText = name;
        document.getElementById('summary_points').innerText = pts + " Poin";
        
        // Tampilkan area QR
        document.getElementById('qr_placeholder').style.display = 'none';
        document.getElementById('qr_result').style.display = 'block';

        // 1. Generate QR saat ini juga
        generateDynamicQR();

        // 2. Set interval pengecekan setiap 1 menit (60000ms)
        // Interval ini akan memanggil generateDynamicQR()
        // Fungsi tsb akan mengecek apakah sudah lewat blok 20 menit atau belum.
        if (qrIntervalId) clearInterval(qrIntervalId);
        qrIntervalId = setInterval(generateDynamicQR, 60000); 
    }

    function generateDynamicQR() {
        const pts = currentSelectedItem.pts;
        const name = currentSelectedItem.name;
        const customerName = document.getElementById('modal_customer_name').innerText;

        // --- LOGIKA ROTASI 20 MENIT ---
        // Date.now() = milidetik sejak 1970
        // 20 menit = 20 * 60 * 1000 = 1.200.000 ms
        // Pembagian dengan Math.floor menghasilkan angka yang sama (timeBlock) selama 20 menit berjalan.
        const timeBlock = Math.floor(Date.now() / (1000 * 60 * 20));

        // Format String QR: REDEEM|Nama|Item|Poin|TimeBlock
        // TimeBlock disematkan agar isi QR berubah setiap siklus 20 menit
        const qrData = `REDEEM|${customerName}|${name}|${pts}|${timeBlock}`;
        
        // URL API QR Code (Tanpa parameter color = Hitam Putih)
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(qrData)}`;
        
        let imgObj = document.getElementById('qr_image');
        
        // Cek apakah URL berubah (artinya blok 20 menit sudah berganti)
        // Jika sama, tidak perlu refresh gambar agar tidak kedip
        if (imgObj.src !== qrUrl) {
            imgObj.style.opacity = '0.5'; // Efek loading visual
            imgObj.src = qrUrl;
            imgObj.onload = function() {
                this.style.opacity = '1';
            };
        }
    }
</script>

{% endblock %}