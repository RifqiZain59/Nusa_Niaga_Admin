{% extends 'base.html' %}
{% block content %}

<style>
    /* --- 1. LAYOUT UTAMA --- */
    body { background-color: #f8fafc; }
    
    .pos-container { 
        height: calc(100vh - 80px); 
        overflow: hidden; 
    } 
    
    /* Area Katalog (Kiri) */
    .catalog-section {
        height: 100%;
        overflow-y: auto;
        padding-right: 10px;
        padding-bottom: 80px; 
    }
    .catalog-section::-webkit-scrollbar { width: 6px; }
    .catalog-section::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* --- 2. FILTER KATEGORI --- */
    .filter-scroll {
        overflow-x: auto; 
        white-space: nowrap; 
        padding-bottom: 5px;
        -ms-overflow-style: none; 
        scrollbar-width: none;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }

    .btn-category {
        border: 1px solid #e2e8f0; 
        background: white; 
        color: #64748b;
        border-radius: 50rem; 
        padding: 8px 20px; 
        font-weight: 600; 
        font-size: 0.85rem;
        margin-right: 8px; 
        transition: all 0.2s;
    }
    .btn-category:hover, .btn-category.active {
        background: #3b82f6; 
        color: white; 
        border-color: #3b82f6;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
    }

    /* --- 3. KARTU PRODUK --- */
    .product-card {
        cursor: pointer; 
        transition: transform 0.2s; 
        border: 1px solid #f1f5f9;
        border-radius: 16px; 
        overflow: hidden; 
        background: white;
        height: 100%;
        position: relative;
    }
    .product-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); 
        border-color: #bfdbfe;
    }
    .product-card:active { transform: scale(0.98); }
    
    .product-img {
        height: 130px; 
        background: #f8fafc; 
        display: flex; 
        align-items: center; 
        justify-content: center;
    }
    .product-img img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
    }

    .stock-badge {
        position: absolute; top: 10px; right: 10px; font-size: 0.7rem;
        padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.95);
        font-weight: 800; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* --- 4. KERANJANG (CART) --- */
    .cart-section {
        background: white; 
        border-left: 1px solid #e2e8f0;
        display: flex; 
        flex-direction: column; 
        height: 100%;
    }
    
    .cart-items-wrapper { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 15px; 
    }

    /* ITEM KERANJANG - Layout Sejajar */
    .cart-item {
        display: flex;
        align-items: center; /* KUNCI: Sejajar Vertikal */
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px dashed #e2e8f0;
        gap: 10px; 
    }

    /* Kiri: Nama & Harga Satuan */
    .cart-item-info {
        flex-grow: 1; 
        min-width: 0; 
        margin-right: 5px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* Tengah: Tombol Qty (Ukuran Tetap) */
    .qty-selector {
        display: flex;
        align-items: center;
        background-color: #f8fafc;
        border-radius: 8px;
        height: 32px;
        width: 90px; /* Lebar Tetap */
        flex-shrink: 0; 
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .btn-qty {
        width: 28px;
        height: 100%;
        border: none;
        background: white;
        color: #3b82f6;
        font-weight: bold;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.1s;
        padding-bottom: 3px;
    }
    .btn-qty:hover { background: #dbeafe; }
    .btn-qty:active { background: #bfdbfe; }

    .qty-number {
        flex-grow: 1;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 700;
        color: #334155;
    }

    /* Kanan: Total Harga (Tanpa Tombol Hapus) */
    .cart-item-price {
        width: 85px; /* Lebar Tetap */
        text-align: right;
        flex-shrink: 0; 
        font-weight: bold;
        color: #2563eb;
        font-size: 0.9rem;
        /* Pastikan teks di tengah vertikal container ini */
        display: flex;
        align-items: center; 
        justify-content: flex-end;
        height: 100%; 
    }
    
    .total-section {
        background: #f8fafc; 
        border-top: 1px solid #e2e8f0; 
        padding: 20px;
    }
</style>

<div class="pos-container row g-0">
    
    <div class="col-lg-8 col-md-7 d-flex flex-column h-100 ps-4 pt-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4 pe-3">
            <div>
                <h4 class="fw-bold text-dark mb-0">Kasir Toko</h4>
                <p class="text-muted small mb-0">Pilih produk untuk ditambahkan.</p>
            </div>
            <div class="position-relative" style="width: 250px;">
                <input type="text" id="searchProduct" class="form-control rounded-pill ps-5 bg-white border-0 shadow-sm" placeholder="Cari menu..." onkeyup="filterProducts()">
                <i class="fas fa-search text-muted position-absolute top-50 start-0 translate-middle-y ms-3"></i>
            </div>
        </div>

        <div class="filter-scroll mb-4">
            <button class="btn btn-category active" onclick="filterCategory('all', this)">Semua</button>
            {% for c in categories %}
                <button class="btn btn-category" onclick="filterCategory('{{ c.id }}', this)">{{ c.name }}</button>
            {% endfor %}
        </div>

        <div class="catalog-section">
            <div class="row g-3 pe-2" id="productGrid">
                {% for p in products %}
                <div class="col-xl-3 col-lg-4 col-6 product-item" 
                     data-name="{{ p.name.lower() }}" 
                     data-category="{{ p.category_id }}">
                    
                    <div class="product-card h-100 position-relative" 
                         onclick="addToCart('{{ p.id }}', '{{ p.name }}', {{ p.price }}, {{ p.stock }})"
                         style="{{ 'opacity: 0.6; pointer-events: none;' if p.stock <= 0 else '' }}">
                        
                        <div class="product-img">
                            <img src="{{ url_for('product_image', id=p.id) }}" onerror="this.src='https://placehold.co/150x150?text=No+Image'">
                        </div>
                        
                        <div class="stock-badge">
                            {% if p.stock > 0 %}
                                Stok: {{ p.stock }}
                            {% else %}
                                <span class="text-danger">Habis</span>
                            {% endif %}
                        </div>

                        <div class="p-3 text-center">
                            <h6 class="fw-bold text-dark mb-1 text-truncate" style="font-size: 0.9rem;" title="{{ p.name }}">{{ p.name }}</h6>
                            <div class="text-primary fw-bold">Rp {{ "{:,.0f}".format(p.price).replace(',', '.') }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="noProductMsg" class="text-center py-5 d-none">
                <i class="fas fa-search fa-3x text-muted opacity-25 mb-3"></i>
                <p class="text-muted">Produk tidak ditemukan.</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-5 h-100">
        <div class="cart-section shadow-lg">
            <div class="p-4 border-bottom bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0"><i class="fas fa-shopping-basket me-2 text-primary"></i>Pesanan</h5>
                    <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3" id="cartCountBadge">0 Item</span>
                </div>
            </div>

            <div class="cart-items-wrapper" id="cartContainer">
                <div class="text-center py-5 mt-5">
                    <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                        <i class="fas fa-cash-register fa-2x text-muted opacity-50"></i>
                    </div>
                    <p class="text-muted small">Belum ada item dipilih.</p>
                </div>
            </div>

            <div class="total-section">
                <form id="transactionForm" action="{{ url_for('add_transaction') }}" method="POST">
                    <input type="hidden" name="cart_data" id="cartDataInput">
                    
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text bg-white"><i class="fas fa-user text-muted"></i></span>
                        <input type="text" name="customer_name" class="form-control" placeholder="Nama Pelanggan (Opsional)">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <input type="text" name="customer_phone" class="form-control form-control-sm" placeholder="No. HP / WA">
                        </div>
                        <div class="col-6">
                            <select name="payment_method" class="form-select form-select-sm">
                                <option value="Tunai">Tunai</option>
                                <option value="QRIS">QRIS</option>
                                <option value="Transfer">Transfer</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                         <input type="text" name="table_number" class="form-control form-control-sm text-center" placeholder="Nomor Meja" required>
                    </div>

                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <input type="text" name="voucher_code" class="form-control text-uppercase" placeholder="KODE VOUCHER">
                            <button class="btn btn-outline-secondary" type="button"><i class="fas fa-tag"></i></button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="text-muted fw-bold">Total Bayar</span>
                        <h3 class="fw-bold text-primary mb-0" id="grandTotalDisplay">Rp 0</h3>
                    </div>

                    <button type="button" onclick="processCheckout()" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm hover-scale">
                        <i class="fas fa-print me-2"></i> PROSES TRANSAKSI
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let cart = [];
    let currentCategory = 'all';

    // --- 1. FILTERING SYSTEM ---
    function filterCategory(catId, btn) {
        document.querySelectorAll('.btn-category').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = catId;
        applyFilter();
    }

    function filterProducts() {
        applyFilter();
    }

    function applyFilter() {
        let term = document.getElementById('searchProduct').value.toLowerCase();
        let items = document.querySelectorAll('.product-item');
        let visible = 0;

        items.forEach(el => {
            let name = el.dataset.name;
            let cat = el.dataset.category;
            let matchSearch = name.includes(term);
            let matchCat = (currentCategory === 'all') || (cat === currentCategory);

            if (matchSearch && matchCat) {
                el.classList.remove('d-none');
                visible++;
            } else {
                el.classList.add('d-none');
            }
        });

        let msg = document.getElementById('noProductMsg');
        if (visible === 0) msg.classList.remove('d-none');
        else msg.classList.add('d-none');
    }

    // --- 2. CART SYSTEM ---
    function addToCart(id, name, price, stock) {
        if (stock <= 0) {
            alert('Stok Habis!');
            return;
        }

        let existing = cart.find(x => x.id === id);
        if (existing) {
            if (existing.qty < stock) {
                existing.qty++;
            } else {
                alert('Stok maksimal tercapai!');
            }
        } else {
            cart.push({ id, name, price, qty: 1, stock });
        }
        renderCart();
    }

    function updateQty(id, change) {
        let item = cart.find(x => x.id === id);
        if (!item) return;

        let newQty = item.qty + change;
        if (newQty > item.stock) {
            alert('Stok tidak cukup!');
            return;
        }

        if (newQty <= 0) {
            // Hapus jika qty 0
            cart = cart.filter(x => x.id !== id);
        } else {
            item.qty = newQty;
        }
        renderCart();
    }

    // --- RENDER CART (FULL BERSIH: TANPA ICON HAPUS) ---
    function renderCart() {
        const container = document.getElementById('cartContainer');
        const badge = document.getElementById('cartCountBadge');
        const totalDisp = document.getElementById('grandTotalDisplay');

        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 mt-5">
                    <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                        <i class="fas fa-cash-register fa-2x text-muted opacity-50"></i>
                    </div>
                    <p class="text-muted small">Belum ada item dipilih.</p>
                </div>`;
            badge.innerText = "0 Item";
            totalDisp.innerText = "Rp 0";
            return;
        }

        let html = '';
        let total = 0;
        let count = 0;

        cart.forEach(item => {
            let subtotal = item.price * item.qty;
            total += subtotal;
            count += item.qty;

            html += `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="fw-bold text-dark small text-truncate" title="${item.name}">
                        ${item.name}
                    </div>
                    <div class="text-muted" style="font-size: 0.7rem;">
                        @ Rp ${new Intl.NumberFormat('id-ID').format(item.price)}
                    </div>
                </div>
                
                <div class="qty-selector">
                    <button type="button" class="btn-qty" onclick="updateQty('${item.id}', -1)">âˆ’</button>
                    <span class="qty-number">${item.qty}</span>
                    <button type="button" class="btn-qty" onclick="updateQty('${item.id}', 1)">+</button>
                </div>

                <div class="cart-item-price">
                    Rp ${new Intl.NumberFormat('id-ID').format(subtotal)}
                </div>
            </div>`;
        });

        container.innerHTML = html;
        badge.innerText = count + " Item";
        totalDisp.innerText = "Rp " + total.toLocaleString('id-ID');
    }

    function processCheckout() {
        if (cart.length === 0) {
            alert('Keranjang kosong!');
            return;
        }
        let form = document.getElementById('transactionForm');
        
        if (!form.reportValidity()) return;

        document.getElementById('cartDataInput').value = JSON.stringify(cart);
        form.submit();
    }
</script>

{% endblock %}